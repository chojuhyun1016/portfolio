<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <timestamp key="BY_DATE" datePattern="yyyy-MM-dd"/>

    <!-- ===== 전역 TurboFilter: traceId 자동 보강 =====
         - 모든 로그 이벤트에서 MDC['traceId']가 비어 있으면 UUID로 채웁니다.
         - 컨트롤러 @Correlate(overrideTraceId=true)가 orderId 등을 발견하면 해당 값으로 자연스럽게 덮어씁니다.
         - order-worker와 동일한 전략을 사용합니다.
    -->
    <turboFilter class="org.example.order.common.support.logging.TraceIdTurboFilter"/>

    <!-- 기존 변수들 그대로 유지 (필요 시 파일 appender 추가 가능) -->
    <property name="LOG_PARENT_PATH" value="./log"/>
    <property name="LOG_CHILD_INFO" value="info"/>
    <property name="LOG_CHILD_ERROR" value="error"/>
    <property name="LOG_BACKUP" value="./log/backup"/>
    <property name="MAX_HISTORY" value="30"/>

    <!-- 권장 로그 패턴: MDC 키 포함 -->
    <property name="LOG_PATTERN"
              value="[%d{yyyy-MM-dd HH:mm:ss}:%-3relative][%thread][%level][trace:%X{traceId:-NA}][req:%X{requestId:-NA}][order:%X{orderId:-NA}][line:%L][%logger][%M] : %msg%n"/>

    <!-- ====== 안전장치: 기본 콘솔/루트 (프로필 불일치/오타여도 콘솔 출력 보장) ====== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
    <!-- =================================================================== -->

    <!-- 프로필별로 필요하면 재정의/추가 -->
    <springProfile name="local">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <springProfile name="beta">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
</configuration>
