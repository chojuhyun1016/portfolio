plugins {
    alias(libs.plugins.springBoot) apply false
    alias(libs.plugins.springDepMgmt) apply false
    alias(libs.plugins.asciidoctor) apply false
}

group = "org.example"
version = "1.0.0"

subprojects {
    apply plugin: "java-library"
    apply plugin: libs.plugins.springDepMgmt.get().pluginId
    // ✅ (요청사항 반영) java-test-fixtures 미사용

    java {
        toolchain { languageVersion = JavaLanguageVersion.of(libs.versions.java.get().toInteger()) }
        withSourcesJar()
        withJavadocJar()
    }

    tasks.withType(JavaCompile).configureEach {
        options.encoding = "UTF-8"
        options.release = libs.versions.java.get().toInteger()
    }

    // Javadoc 빌드 완화
    tasks.withType(Javadoc).configureEach {
        options.encoding = "UTF-8"
        options.addStringOption("Xdoclint:none", "-quiet")
        failOnError = false
    }

    // 리소스 중복 방지 (test/integrationTest 모두 포함)
    tasks.withType(ProcessResources).configureEach {
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    }

    tasks.withType(Test).configureEach {
        useJUnitPlatform()
        testLogging {
            events "FAILED", "SKIPPED"
            exceptionFormat "FULL"
        }
    }

    dependencies {
        // 공통 유틸
        implementation(libs.guava)

        // Lombok (main/test 공통)
        compileOnly(libs.lombok)
        annotationProcessor(libs.lombok)
        testCompileOnly(libs.lombok)
        testAnnotationProcessor(libs.lombok)

        // 공통 테스트
        testImplementation(libs.springBootStarterTest)
        testImplementation(platform(libs.testcontainersBom))
    }

    // ===== BOM =====
    dependencyManagement {
        imports {
            mavenBom "org.springframework.boot:spring-boot-dependencies:${libs.versions.springBoot.get()}"
            mavenBom "org.springframework.cloud:spring-cloud-dependencies:${libs.versions.springCloud.get()}"
            mavenBom "io.awspring.cloud:spring-cloud-aws-dependencies:${libs.versions.springAws.get()}"
        }
    }

    // ===== 통합 테스트 소스셋/태스크 (공통) =====
    sourceSets {
        integrationTest {
            java.srcDir file("src/integrationTest/java")
            resources.srcDir file("src/integrationTest/resources")

            // ✅ [중요] test 산출물(TestBootApp 등)을 **제외**하여 @SpringBootConfiguration 충돌 방지
            // 기존: compileClasspath += sourceSets.main.output + sourceSets.test.output + configurations.testRuntimeClasspath
            // 변경: test.output 제거
            compileClasspath += sourceSets.main.output + configurations.testRuntimeClasspath
            runtimeClasspath += output + compileClasspath

            // ✅ (요청사항 반영) testFixtures 미사용 → 별도 추가 없음
        }
    }

    configurations {
        // test 구성을 integrationTest에 상속
        integrationTestImplementation.extendsFrom testImplementation
        integrationTestRuntimeOnly.extendsFrom testRuntimeOnly

        // Lombok 확장 (없으면 @Slf4j 인식 실패)
        integrationTestCompileOnly.extendsFrom testCompileOnly
        integrationTestAnnotationProcessor.extendsFrom testAnnotationProcessor

        // ✅ (요청사항 반영) testFixtures 확장 없음
    }

    tasks.register("integrationTest", Test) {
        description = "Runs integration tests."
        group = "verification"
        testClassesDirs = sourceSets.integrationTest.output.classesDirs
        classpath = sourceSets.integrationTest.runtimeClasspath
        useJUnitPlatform()
        shouldRunAfter tasks.named("test")
        // ✅ 통합 테스트 기본 프로파일
        systemProperty "spring.profiles.active", System.getProperty("spring.profiles.active", "integration")
        // ✅ 더 이상 testClasses 선행 필요 없음(클래스패스에서 test 산출물 제외)
        testLogging {
            events "PASSED", "FAILED", "SKIPPED"
            exceptionFormat "FULL"
        }
    }
}

// 실행 모듈에서만 spring-boot 적용할 때 사용 (예시)
// configure([
//     project(":order-api:order-api-master"),
//     project(":order-api:order-api-web"),
//     project(":order-worker"),
//     project(":order-batch")
// ]) {
//     apply plugin: libs.plugins.springBoot.get().pluginId
// }

// (선택) REST Docs 샘플 — 주석 해제 시 대상 모듈에만 적용
// configure([project(":order-api:order-api-master")]) {
//     apply plugin: "org.asciidoctor.jvm.convert"
//     configurations { asciidoctorExt }
//     dependencies { asciidoctorExt "org.springframework.restdocs:spring-restdocs-asciidoctor" }
//     tasks.named("asciidoctor") {
//         dependsOn test
//         baseDirFollowsSourceFile()
//     }
//     bootJar {
//         dependsOn asciidoctor
//         from("${asciidoctor.outputDir}/") {
//             into 'static/docs'
//         }
//     }
//     dependencies {
//         testImplementation 'org.springframework.restdocs:spring-restdocs-mockmvc'
//     }
// }
